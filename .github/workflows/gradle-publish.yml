# Dispatch 명령어를 통해 수동 실행
name: Deploy Spring Boot to Ubuntu Server without Docker Container

on:
  workflow_dispatch: # 수동 실행 트리거
    inputs:
      environment:
        description: "Deployment environment (e.g., staging, production)"
        required: true
        default: "production"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 설치
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradlew 권한 설정
      - name: Grant execute permission to Gradlew
        run: chmod +x ./gradlew

      # 4. Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 5. 서버로 JAR 파일 전송
      - name: Transfer JAR to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: 17596 # SSH 포트 설정
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          source: build/libs/server-0.0.1-SNAPSHOT.jar # 정확한 JAR 파일 지정
          target: /home/${{ secrets.SERVER_USER }}/app/build/libs
          debug: true

      # 6. 서버에서 Spring Boot 실행 (tmux 사용)
      - name: Run Spring Boot on server using tmux
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: 17596
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            # 환경 변수를 직접 설정
            export DB_URL=${{ secrets.DB_URL }}
            export DB_USERNAME=${{ secrets.DB_USERNAME }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export ML_API_KEY=${{ secrets.ML_API_KEY }}
            
            # tmux가 설치되어 있지 않으면 설치
            if ! command -v tmux &> /dev/null; then
              sudo apt update && sudo apt install -y tmux
            fi
            
            # tmux 세션에서 Spring Boot 실행
            tmux new-session -d -s spring-boot "cd /home/${{ secrets.SERVER_USER }}/app/build/libs && java -jar server-0.0.1-SNAPSHOT.jar > /home/${{ secrets.SERVER_USER }}/app/server.log 2>&1"
          command_timeout: 300s
          debug: true

      # 7. 서버에서 tmux 세션 확인 (선택 사항)
      - name: Check tmux session
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: 17596
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: tmux ls
          debug: true
